// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Organisation & team hierarchy
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Organisations this user owns (Admin/Owner)
  ownedOrganizations Organization[] @relation("OrganizationOwner")

  // If this user is a technician, who manages them (typically a MANAGER; could also be ADMIN)
  managedById String?
  managedBy   User?   @relation("UserManager", fields: [managedById], references: [id], onDelete: SetNull)
  manages     User[]  @relation("UserManager")

  // Subscription fields (temporarily optional for migration)
  subscriptionStatus SubscriptionStatus?
  subscriptionPlan   String?
  subscriptionId     String?             @unique
  stripeCustomerId   String?             @unique
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?
  creditsRemaining   Int?
  totalCreditsUsed   Int?
  lastBillingDate    DateTime?
  nextBillingDate    DateTime?
  
  // Add-on tracking
  addonReports       Int?      @default(0) // Additional reports from add-ons
  monthlyReportsUsed Int?      @default(0) // Reports used this month
  monthlyResetDate   DateTime? // Date when monthly usage resets
  signupBonusApplied Boolean?  @default(false) // Track if signup bonus has been applied
  
  // Password management
  mustChangePassword Boolean?  @default(false) // True if user needs to change temporary password

  // Premium Features
  hasPremiumInspectionReports Boolean @default(false) // Access to 3-stakeholder PDF generator
  
  // Quick Fill Credits (for free users)
  quickFillCreditsRemaining Int? @default(1) // Free users get 1 Quick Fill credit
  totalQuickFillUsed Int? @default(0) // Track total Quick Fill usage
  
  // Deepseek API Key (for Quick Fill functionality)
  deepseekApiKey String? @db.Text // Encrypted Deepseek API key for Quick Fill

  // Business Information
  businessName    String?
  businessAddress String?
  businessLogo    String? // Cloudinary URL
  businessABN     String?
  businessPhone   String?
  businessEmail   String?

  accounts             Account[]
  sessions             Session[]
  reports              Report[]
  clients              Client[]
  integrations         Integration[]
  costLibraries        CostLibrary[]
  scopes               Scope[]
  estimates            Estimate[]
  pricingConfig        CompanyPricingConfig?
  addonPurchases       AddonPurchase[]
  claimAnalysisBatches ClaimAnalysisBatch[]
  standardTemplates    StandardTemplate[]
  inspections          Inspection[]
  chatMessages         ChatMessage[]
  usageEvents          UsageEvent[]          @relation("usageEvents")
  emailConnection      EmailConnection?
  scheduledEmails      ScheduledEmail[]
  emailAudits          EmailAudit[]
  formTemplates        FormTemplate[]
  formSubmissions      FormSubmission[]

  // AI Assistant Tier (Phase 1 - Metering)
  monthlyUsageCap Float? // Optional: cap usage to prevent runaway costs

  // Interview System
  interviewTier                        SubscriptionTierLevel @default(STANDARD)
  preferredQuestionStyle               String? // verbose, concise, technical
  autoAcceptSuggestionsAboveConfidence Float? // e.g., 90
  subscriptionTier                     SubscriptionTier?     @relation(fields: [subscriptionTierId], references: [id], onDelete: SetNull)
  subscriptionTierId                   String?
  interviewSessions                    InterviewSession[]

  // Team invites
  createdInvites UserInvite[] @relation("InvitesCreatedBy")
  managedInvites UserInvite[] @relation("InvitesManagedBy")
  
  // Reports assigned to this user (as Manager or Admin)
  assignedReportsAsManager Report[] @relation("ReportManager")
  assignedReportsAsAdmin   Report[] @relation("ReportAdmin")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([email])
}

model Client {
  id            String                   @id @default(cuid())
  name          String
  email         String
  phone         String?
  address       String?
  company       String?
  contactPerson String?
  notes         String?                  @db.Text
  status        ClientStatus             @default(ACTIVE)
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  userId        String
  user          User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reports       Report[]
  search_vector Unsupported("tsvector")?

  @@index([search_vector], type: Gin)
}

model Report {
  id              String       @id @default(cuid())
  title           String
  description     String?
  status          ReportStatus @default(DRAFT)
  clientName      String
  propertyAddress String
  hazardType      String
  insuranceType   String
  totalCost       Float?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId        String?
  client          Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)
  
  // Team assignment: For Technicians, assign to a Manager; For Managers, assign to an Admin
  assignedManagerId String? // Manager assigned to this report (for Technicians)
  assignedManager   User?   @relation("ReportManager", fields: [assignedManagerId], references: [id], onDelete: SetNull)
  assignedAdminId   String? // Admin assigned to this report (for Managers)
  assignedAdmin     User?   @relation("ReportAdmin", fields: [assignedAdminId], references: [id], onDelete: SetNull)

  // Phase 2: Initial Data Entry Fields
  clientContactDetails     String? // Phone, email, etc.
  propertyPostcode         String? // Mandatory for state detection
  claimReferenceNumber     String? // If existing claim
  incidentDate             DateTime? // Date when water damage occurred
  technicianAttendanceDate DateTime? // Date when technician attended
  technicianName           String? // Technician's name if available
  technicianFieldReport    String?   @db.Text // The raw technician report text
  
  // New Fields: Property ID and Job Number
  propertyId String? // Property identifier
  jobNumber  String? // Job number/reference
  
  // Cover Page: Instructions/Standards References
  reportInstructions String? @db.Text // Instructions/standards references for report
  
  // Additional Contact Information: Builder/Developer
  builderDeveloperCompanyName String?
  builderDeveloperContact     String?
  builderDeveloperAddress     String?
  builderDeveloperPhone       String?
  
  // Additional Contact Information: Owner/Management
  ownerManagementContactName String?
  ownerManagementPhone       String?
  ownerManagementEmail       String?
  
  // Previous Maintenance & Repair History
  lastInspectionDate                  DateTime?
  buildingChangedSinceLastInspection  String?
  structureChangesSinceLastInspection String?
  previousLeakage                     String?
  emergencyRepairPerformed            String?

  // Report Generation Stage
  reportDepthLevel String? // Basic / Enhanced / Optimised
  reportVersion    Int     @default(1) // Version tracking

  // Phase 3: Technician Report Analysis
  technicianReportAnalysis String? @db.Text // JSON: analysis results from AI

  // Phase 4: Tiered Questioning Responses (stored as JSON)
  tier1Responses String? @db.Text // JSON: Tier 1 Q&A responses
  tier2Responses String? @db.Text // JSON: Tier 2 Q&A responses
  tier3Responses String? @db.Text // JSON: Tier 3 Q&A responses

  // Phase 6: Scope of Works Document
  scopeOfWorksDocument String? @db.Text // Generated Scope of Works document
  scopeOfWorksData     String? @db.Text // JSON: Scope of Works line items and data

  // Phase 7: Cost Estimation Document
  costEstimationDocument String? @db.Text // Generated Cost Estimation document
  costEstimationData     String? @db.Text // JSON: Cost Estimation line items and calculations

  // Phase 8: Version Control & Audit Trail
  versionHistory    String?   @db.Text // JSON: Array of version changes
  lastEditedBy      String? // User ID who last edited
  lastEditedAt      DateTime? // Timestamp of last edit
  completenessScore Int? // 0-100 percentage of completion

  // Phase 9: Geographic Intelligence
  geographicIntelligence String? @db.Text // JSON: Postcode-based weather, council info, etc.

  // Phase 11: Validation & Quality Control
  validationWarnings String? @db.Text // JSON: Array of validation warnings
  validationErrors   String? @db.Text // JSON: Array of validation errors

  // IICRC S500 Compliance Fields
  reportNumber   String?
  inspectionDate DateTime?
  waterCategory  String? // Category 1, 2, or 3
  waterClass     String? // Class 1, 2, 3, or 4
  sourceOfWater  String?
  affectedArea   Float? // Square footage
  safetyHazards  String?   @db.Text
  equipmentUsed  String?   @db.Text
  dryingPlan     String?   @db.Text
  completionDate DateTime?

  // Property Intelligence (Assessment Report Data Architecture)
  buildingAge   Int? // Year Built - trigger for Asbestos/Lead logic pre-1990
  structureType String? // e.g., "Brick Veneer", "Slab on Ground"
  accessNotes   String? @db.Text // e.g., "Level driveway, truck mount access"

  // Hazard Profile (Assessment Report Data Architecture)
  methamphetamineScreen    String? // "POSITIVE" or "NEGATIVE"
  methamphetamineTestCount Int? // Number of tests performed
  biologicalMouldDetected  Boolean @default(false) // Visible growth detected
  biologicalMouldCategory  String? // e.g., "CAT 3" if applicable

  // Timeline Estimation Data (Assessment Report Data Architecture)
  phase1StartDate DateTime? // Make-safe start
  phase1EndDate   DateTime? // Make-safe end
  phase2StartDate DateTime? // Remediation/Drying start
  phase2EndDate   DateTime? // Remediation/Drying end
  phase3StartDate DateTime? // Verification/Handover start
  phase3EndDate   DateTime? // Verification/Handover end

  // Insurer/Client Name (separate from clientName for clarity)
  insurerName String?

  // Detailed Assessment Fields
  structuralDamage  String? @db.Text
  contentsDamage    String? @db.Text
  hvacAffected      Boolean @default(false)
  electricalHazards String? @db.Text
  microbialGrowth   String? @db.Text

  // Drying Plan Details
  dehumidificationCapacity Float?
  airmoversCount           Int?
  targetHumidity           Float?
  targetTemperature        Float?
  estimatedDryingTime      Int? // Hours

  // Monitoring Data
  psychrometricReadings String? @db.Text
  moistureReadings      String? @db.Text
  equipmentPlacement    String? @db.Text

  // Psychrometric Assessment Data (Equipment Tools)
  psychrometricAssessment String? @db.Text // JSON: waterClass, temperature, humidity, dryingPotential, systemType
  scopeAreas              String? @db.Text // JSON: Array of areas with dimensions, volume, wet percentage
  equipmentSelection      String? @db.Text // JSON: Selected equipment with quantities, costs, and specifications
  equipmentCostTotal      Float? // Total cost of selected equipment
  estimatedDryingDuration Int? // Days

  // Compliance Documentation
  safetyPlan                  String? @db.Text
  containmentSetup            String? @db.Text
  decontaminationProcedures   String? @db.Text
  postRemediationVerification String? @db.Text

  // Insurance Information
  propertyCover        String? @db.Text
  contentsCover        String? @db.Text
  liabilityCover       String? @db.Text
  businessInterruption String? @db.Text
  additionalCover      String? @db.Text

  // AI-Generated Detailed Report
  detailedReport String? @db.Text

  // Document URLs
  excelReportUrl   String? // Cloudinary URL for Excel report
  inspectionPdfUrl String? // Cloudinary URL for inspection PDF

  // Scoping & Estimation
  scope     Scope?
  estimates Estimate[]

  // Email Delivery
  scheduledEmails ScheduledEmail[]
  emailAudits     EmailAudit[]

  // Forms System
  formSubmissions FormSubmission[]

  // Authority Forms
  authorityForms AuthorityFormInstance[]

  // NIR Integration
  inspection Inspection?

  // Full-Text Search
  search_vector Unsupported("tsvector")?

  // NEW: Optional Regulatory Citations (Phase 5 - Tick and Flick feature)
  includeRegulatoryCitations Boolean @default(false) // Client preference for regulatory citations

  @@index([search_vector], type: Gin)
  @@index([userId, createdAt])
  @@index([userId, hazardType])
  @@index([userId, status])
  @@index([clientId, createdAt])
  @@index([includeRegulatoryCitations]) // Index for efficient filtering
}

enum Role {
  USER
  ADMIN
  MANAGER
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  ownerId   String
  owner     User     @relation("OrganizationOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members   User[]
  invites   UserInvite[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserInvite {
  id             String   @id @default(cuid())
  token          String   @unique
  email          String
  role           Role
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // If set, the invited user will be assigned under this manager
  managedById String?
  managedBy   User? @relation("InvitesManagedBy", fields: [managedById], references: [id], onDelete: SetNull)

  createdById String
  createdBy   User   @relation("InvitesCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([organizationId])
  @@index([createdById])
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PROSPECT
  ARCHIVED
}

enum ReportStatus {
  DRAFT
  PENDING
  APPROVED
  COMPLETED
  ARCHIVED
}

model Integration {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Service identification
  provider    IntegrationProvider
  name        String // Display name
  description String?
  icon        String?
  status      IntegrationStatus   @default(DISCONNECTED)

  // Legacy fields (kept for backwards compatibility)
  apiKey String? @db.Text
  config String? @db.Text // JSON configuration

  // OAuth tokens (encrypted at application level)
  accessToken    String?   @db.Text
  refreshToken   String?   @db.Text
  tokenExpiresAt DateTime?

  // Service-specific metadata
  tenantId  String? // Xero, MYOB
  realmId   String? // QuickBooks
  companyId String? // ServiceM8, Ascora

  // Sync tracking
  lastSyncAt DateTime?
  syncError  String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  externalClients ExternalClient[]
  externalJobs    ExternalJob[]
  syncLogs        IntegrationSyncLog[]

  @@unique([userId, provider])
  @@index([userId])
  @@index([provider])
  @@index([status])
}

model CostLibrary {
  id          String     @id @default(cuid())
  name        String
  region      String
  description String?    @db.Text
  isDefault   Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       CostItem[]
}

model CostItem {
  id          String      @id @default(cuid())
  category    String
  description String
  rate        Float
  unit        String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  libraryId   String
  library     CostLibrary @relation(fields: [libraryId], references: [id], onDelete: Cascade)
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  SYNCING
}

enum IntegrationProvider {
  XERO
  QUICKBOOKS
  MYOB
  SERVICEM8
  ASCORA
}

// External Client from integration (synced data)
model ExternalClient {
  id            String      @id @default(cuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  externalId String // ID in external system
  name       String
  email      String?
  phone      String?
  address    String?
  rawData    Json // Full response from external API

  // Link to RestoreAssist contact (optional)
  contactId String?

  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([integrationId, externalId])
  @@index([integrationId])
  @@index([contactId])
}

// External Job from integration (synced data)
model ExternalJob {
  id            String      @id @default(cuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  externalId       String // ID in external system
  title            String
  status           String?
  clientExternalId String? // Reference to client in external system
  address          String?
  description      String? @db.Text
  rawData          Json // Full response from external API

  // Link to RestoreAssist claim (optional)
  claimId String?

  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([integrationId, externalId])
  @@index([integrationId])
  @@index([claimId])
}

// Integration Sync Log (audit trail)
model IntegrationSyncLog {
  id            String      @id @default(cuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  syncType         String // CLIENTS, JOBS, FULL
  status           String // SUCCESS, FAILED, PARTIAL
  recordsProcessed Int     @default(0)
  recordsFailed    Int     @default(0)
  errorMessage     String? @db.Text

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([integrationId])
  @@index([startedAt])
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELED
  EXPIRED
  PAST_DUE
}

// Scope Models
model Scope {
  id       String @id @default(cuid())
  reportId String @unique
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Step 1: Input & Data Ingestion
  scopeType     String // WATER, FIRE, MOULD, MULTI_LOSS
  siteVariables String? @db.Text // JSON: structure, materials, etc.

  // Step 2: Labour Parameters (stored as JSON)
  labourParameters String? @db.Text // JSON: roles, rates, modifiers

  // Step 3: Equipment Parameters (stored as JSON)
  equipmentParameters String? @db.Text // JSON: equipment list with rates

  // Step 4: Chemical Application (stored as JSON)
  chemicalApplication String? @db.Text // JSON: chemicals with rates and areas

  // Step 5: Time & Productivity (stored as JSON)
  timeCalculations String? @db.Text // JSON: productivity, efficiency factors

  // Step 6: Scope Summary (calculated)
  labourCostTotal    Float?
  equipmentCostTotal Float?
  chemicalCostTotal  Float?
  totalDuration      Float? // Days

  // Step 7: Compliance
  complianceNotes String? @db.Text
  assumptions     String? @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  estimate Estimate?
}

// Estimate Models
model Estimate {
  id       String  @id @default(cuid())
  reportId String
  report   Report  @relation(fields: [reportId], references: [id], onDelete: Cascade)
  scopeId  String? @unique
  scope    Scope?  @relation(fields: [scopeId], references: [id], onDelete: SetNull)

  // Workflow State
  status  EstimateStatus @default(DRAFT)
  version Int            @default(1)

  // Input Parameters (stored as JSON)
  rateTables       String? @db.Text // JSON: labour, subcontractor, equipment rates
  commercialParams String? @db.Text // JSON: OH&P, contingency, escalation

  // Totals (calculated)
  labourSubtotal        Float?
  equipmentSubtotal     Float?
  chemicalsSubtotal     Float?
  subcontractorSubtotal Float?
  travelSubtotal        Float?
  wasteSubtotal         Float?
  overheads             Float?
  profit                Float?
  contingency           Float?
  escalation            Float?
  subtotalExGST         Float?
  gst                   Float?
  totalIncGST           Float?

  // Assumptions & Compliance
  assumptions         String? @db.Text
  inclusions          String? @db.Text
  exclusions          String? @db.Text
  allowances          String? @db.Text
  complianceStatement String? @db.Text
  disclaimer          String? @db.Text

  // Approval & Versioning
  approverName      String?
  approverRole      String?
  approverSignature String? // Base64 signature image
  approvedAt        DateTime?
  estimatedDuration Float? // Days

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String

  // Relations
  lineItems  EstimateLineItem[]
  versions   EstimateVersion[]
  variations EstimateVariation[]
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String

  @@index([reportId, createdAt])
}

model EstimateLineItem {
  id         String   @id @default(cuid())
  estimateId String
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  // Line Item Details
  code        String?
  category    String // Prelims, Mitigation, Demolition, Restoration, Specialist, Contents, Travel, Compliance, Admin
  description String
  qty         Float
  unit        String
  rate        Float
  formula     String? // Formula breakdown for info hover
  subtotal    Float // qty * rate

  // Flags & Audit
  isScopeLinked    Boolean   @default(false) // If true, qty is immutable except by changing scope
  isEstimatorAdded Boolean   @default(true)
  createdBy        String
  modifiedBy       String?
  modifiedAt       DateTime?
  changeReason     String?   @db.Text

  // Ordering
  displayOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([estimateId])
  @@index([category])
}

model EstimateVersion {
  id         String   @id @default(cuid())
  estimateId String
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  version   Int
  changes   String?  @db.Text // JSON: array of changes
  reason    String?  @db.Text
  createdBy String
  createdAt DateTime @default(now())

  // Snapshot data
  snapshot String? @db.Text // JSON: full estimate snapshot

  @@unique([estimateId, version])
  @@index([estimateId])
}

model EstimateVariation {
  id         String   @id @default(cuid())
  estimateId String
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  variationNumber Int
  reason          String  @db.Text
  evidence        String? @db.Text // JSON: photos, notes

  // Delta changes (stored as JSON)
  addedItems   String? @db.Text // JSON array
  removedItems String? @db.Text // JSON array
  changedItems String? @db.Text // JSON array

  // Totals
  previousTotal   Float
  variationAmount Float
  newTotal        Float

  createdAt DateTime @default(now())
  createdBy String

  @@unique([estimateId, variationNumber])
  @@index([estimateId])
}

enum EstimateStatus {
  DRAFT
  INTERNAL_REVIEW
  CLIENT_REVIEW
  APPROVED
  LOCKED
}

// Company Pricing Configuration Model
model CompanyPricingConfig {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Labour Rates - Master Qualified Technician
  masterQualifiedNormalHours Float
  masterQualifiedSaturday    Float
  masterQualifiedSunday      Float

  // Labour Rates - Qualified Technician
  qualifiedTechnicianNormalHours Float
  qualifiedTechnicianSaturday    Float
  qualifiedTechnicianSunday      Float

  // Labour Rates - Labourer
  labourerNormalHours Float
  labourerSaturday    Float
  labourerSunday      Float

  // Equipment Daily Rental Rates
  airMoverAxialDailyRate           Float
  airMoverCentrifugalDailyRate     Float
  dehumidifierLGRDailyRate         Float
  dehumidifierDesiccantDailyRate   Float
  afdUnitLargeDailyRate            Float
  extractionTruckMountedHourlyRate Float
  extractionElectricHourlyRate     Float
  injectionDryingSystemDailyRate   Float

  // Chemical Treatment Rates (per sqm)
  antimicrobialTreatmentRate    Float
  mouldRemediationTreatmentRate Float
  biohazardTreatmentRate        Float

  // Fees
  administrationFee                 Float
  callOutFee                        Float
  thermalCameraUseCostPerAssessment Float

  // Custom Fields (JSON: { category: [{ name: string, value: number }] })
  customFields String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Add-on Purchase Tracking
model AddonPurchase {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Add-on details
  addonKey    String // e.g., "pack8", "pack25", "pack60"
  addonName   String // Display name
  reportLimit Int // Number of reports in this add-on
  amount      Float // Price paid
  currency    String @default("AUD")
  
  // Stripe details
  stripeSessionId       String? @unique
  stripePaymentIntentId String? @unique
  
  // Status
  status AddonPurchaseStatus @default(PENDING)
  
  // Dates
  purchasedAt DateTime  @default(now())
  expiresAt   DateTime? // When this add-on expires (if applicable)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([purchasedAt])
}

enum AddonPurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Claim Analysis Models - For analyzing completed claims from Google Drive
model ClaimAnalysisBatch {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Batch details
  folderId       String // Google Drive folder ID
  folderName     String?
  status         ClaimAnalysisBatchStatus @default(PENDING)
  totalFiles     Int                      @default(0)
  processedFiles Int                      @default(0)
  failedFiles    Int                      @default(0)
  
  // Results summary
  averageCompletenessScore Float?
  averageComplianceScore   Float?
  totalMissingElements     Int    @default(0)
  estimatedRevenueRecovery Float? // Estimated additional revenue from missing items
  
  // Metadata
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  errorMessage String?   @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  analyses ClaimAnalysis[]
  
  @@index([userId])
  @@index([status])
}

enum ClaimAnalysisBatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIAL
}

model ClaimAnalysis {
  id      String             @id @default(cuid())
  batchId String
  batch   ClaimAnalysisBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  
  // Source file information
  googleDriveFileId String  @unique
  fileName          String
  fileSize          Int? // Bytes
  fileUrl           String? // Google Drive file URL
  
  // Extracted claim information
  claimNumber     String?
  propertyAddress String?
  technicianName  String?
  inspectionDate  DateTime?
  reportDate      DateTime?
  clientName      String?
  insurerName     String?
  
  // Analysis scores (0-100)
  completenessScore    Int? // How complete is the report
  complianceScore      Int? // IICRC compliance score
  standardizationScore Int? // How well it matches standard format
  documentationScore   Int? // Quality of documentation
  billingAccuracyScore Int? // Accuracy of billing items
  
  // Report structure analysis
  reportStructure   String? @db.Text // JSON: sections found, order, completeness
  reportFlow        String? @db.Text // JSON: flow analysis, technician patterns
  technicianPattern String? @db.Text // JSON: technician-specific patterns
  
  // Missing elements summary
  missingIICRCElements Int @default(0)
  missingOHSElements   Int @default(0)
  missingBillingItems  Int @default(0)
  missingDocumentation Int @default(0)
  
  // Estimated impact
  estimatedMissingRevenue Float? // Estimated revenue from missing billable items
  estimatedTimeSavings    Float? // Estimated hours saved with standardization
  
  // Full analysis data
  fullAnalysisData String? @db.Text // JSON: complete analysis results
  extractedText    String? @db.Text // Extracted text from PDF
  
  // Status
  status       ClaimAnalysisStatus @default(PENDING)
  errorMessage String?             @db.Text
  
  // Metadata
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  missingElements MissingElement[]
  
  @@index([batchId])
  @@index([technicianName])
  @@index([status])
  @@index([completenessScore])
}

enum ClaimAnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model MissingElement {
  id         String        @id @default(cuid())
  analysisId String
  analysis   ClaimAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  // Element details
  category    MissingElementCategory
  elementType String // e.g., "IICRC S500 Water Category", "OH&S Confined Space Permit"
  elementName String // Specific element name
  description String?                @db.Text
  severity    MissingElementSeverity @default(MEDIUM)
  
  // Standards reference
  standardReference String? // e.g., "IICRC S500 Section 4.2", "OH&S Act 2004"
  requirementText   String? @db.Text // Text of the requirement
  
  // Billing impact (if applicable)
  isBillable        Boolean @default(false)
  estimatedCost     Float? // Estimated cost if this was billed
  estimatedHours    Float? // Estimated hours if this was included
  suggestedLineItem String? @db.Text // Suggested line item description
  
  // Context
  context        String? @db.Text // Where this should appear in the report
  suggestedValue String? @db.Text // Suggested value/content
  
  createdAt DateTime @default(now())
  
  @@index([analysisId])
  @@index([category])
  @@index([severity])
  @@index([isBillable])
}

enum MissingElementCategory {
  IICRC_COMPLIANCE
  OH_S_POLICY
  WORKING_AT_HEIGHTS
  CONFINED_SPACES
  PPE_REQUIREMENTS
  BILLING_ITEM
  DOCUMENTATION
  SCOPE_OF_WORKS
  JOB_COSTING
  ENVIRONMENTAL_CONTROLS
  WASTE_DISPOSAL
  QUALITY_CONTROL
  OTHER
}

enum MissingElementSeverity {
  CRITICAL // Must be included, compliance issue
  HIGH // Important, likely billing impact
  MEDIUM // Should be included, best practice
  LOW // Nice to have, minor improvement
}

// Standardized Templates generated from analysis
model StandardTemplate {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Template details
  templateType StandardTemplateType
  name         String
  version      Int                  @default(1)
  description  String?              @db.Text
  
  // Template structure
  structure String  @db.Text // JSON: template structure, sections, fields
  checklist String? @db.Text // JSON: required elements checklist
  lineItems String? @db.Text // JSON: standard line items for billing
  
  // Generation metadata
  generatedFromBatchId String? // Which batch analysis generated this
  basedOnAnalysisCount Int? // How many claims were analyzed to create this
  
  // Status
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // Default template for this type
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  
  @@index([templateType])
  @@index([isActive])
  @@index([isDefault])
}

enum StandardTemplateType {
  INITIAL_INSPECTION_REPORT
  SCOPE_OF_WORKS
  JOB_COSTING
  COMPLIANCE_CHECKLIST
  BILLING_TEMPLATE
}

// ============================================
// NIR (National Inspection Report) Models
// ============================================

// Main Inspection Record
model Inspection {
  id       String  @id @default(cuid())
  reportId String? @unique // Link to existing Report if applicable
  report   Report? @relation(fields: [reportId], references: [id], onDelete: SetNull)
  
  // Inspection Metadata
  inspectionNumber String   @unique // NIR-YYYY-MM-XXXX format
  propertyAddress  String
  propertyPostcode String // Required for state detection
  inspectionDate   DateTime @default(now())
  technicianName   String?
  technicianId     String? // Link to technician user if available
  
  // Status
  status      InspectionStatus @default(DRAFT)
  submittedAt DateTime?
  processedAt DateTime?
  
  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  environmentalData EnvironmentalData?
  moistureReadings  MoistureReading[]
  affectedAreas     AffectedArea[]
  scopeItems        ScopeItem[]
  classifications   Classification[]
  costEstimates     CostEstimate[]
  auditLogs         AuditLog[]
  photos            InspectionPhoto[]
  usageEvents       UsageEvent[]       @relation("usageEvents")

  // AI Assistant Tier (Phase 1 - Metering)
  totalUsageCost Float @default(0) // Cached total cost for this inspection

  // AI Assistant Tier (Phase 3 - LiDAR)
  lidarScans LidarScan[]

  // AI Assistant Tier (Phase 4 - Voice AI)
  voiceNotes VoiceNote[]

  // AI Assistant Tier (Phase 5 - Property Data Integration)
  propertyYearBuilt        Int? // Exact year built
  propertyWallMaterial     String? // "Brick", "Timber", "Concrete", "Brick Veneer"
  propertyWallConstruction String? // "Single Brick", "Double Brick", "Cavity", "Veneer"
  propertyRoofMaterial     String? // "Tiles", "Metal", "Membrane", "Slate"
  propertyFloorType        String? // "Concrete Slab", "Suspended Timber", "Raised"
  propertyFloorArea        Float? // Total floor area (sqm)
  propertyBedrooms         Int? // Number of bedrooms
  propertyBathrooms        Int? // Number of bathrooms
  propertyLandArea         Float? // Land area (sqm)
  propertyStories          Int? // Building height (stories)

  // Lookup metadata
  propertyDataSource    String? // "CORELOGIC" or "MANUAL"
  propertyDataFetchedAt DateTime? // Timestamp of fetch

  // Visual Moisture Mapping
  floorPlanImageUrl String? // URL to uploaded floor plan image

  // Relations
  propertyLookupCache PropertyLookup?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Full-Text Search
  search_vector Unsupported("tsvector")?

  @@index([userId])
  @@index([status])
  @@index([inspectionDate])
  @@index([propertyPostcode])
  @@index([search_vector], type: Gin)
}

enum InspectionStatus {
  DRAFT
  SUBMITTED
  PROCESSING
  CLASSIFIED
  SCOPED
  ESTIMATED
  COMPLETED
  REJECTED
}

// Environmental Data (Temperature, Humidity, Dew Point, etc.)
model EnvironmentalData {
  id           String     @id @default(cuid())
  inspectionId String     @unique
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  // Environmental Measurements
  ambientTemperature Float // °F or °C
  humidityLevel      Float // Percentage (0-100)
  dewPoint           Float? // °F or °C
  airCirculation     Boolean @default(false)
  
  // Additional Context
  weatherConditions String? @db.Text
  notes             String? @db.Text
  
  recordedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Moisture Readings (Location-specific measurements)
model MoistureReading {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  // Location & Surface
  location      String // Room/Zone identifier
  surfaceType   String // drywall, wood, carpet, concrete, etc.
  moistureLevel Float // Percentage (0-100)
  depth         String // Surface | Subsurface
  
  // Visual Mapping Coordinates (for floor plan overlay)
  mapX Float? // X coordinate on floor plan (0-800)
  mapY Float? // Y coordinate on floor plan (0-600)
  
  // Additional Context
  notes    String? @db.Text
  photoUrl String? // Link to photo if available
  
  recordedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([inspectionId])
  @@index([surfaceType])
}

// Affected Areas (Room/Zone with Category/Class)
model AffectedArea {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  // Area Identification
  roomZoneId            String // Room/Zone identifier
  affectedSquareFootage Float // Square footage affected
  
  // Water Source & Timing
  waterSource   String // clean water, grey water, black water
  timeSinceLoss Float? // Hours since loss occurred
  
  // IICRC Classification (auto-determined by system)
  category String? // A, B, C, D (or 1, 2, 3, 4)
  class    String? // 1, 2, 3, 4
  
  // Additional Context
  description String? @db.Text
  photos      String? @db.Text // JSON array of photo URLs
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([inspectionId])
  @@index([category])
  @@index([class])
}

// Scope Items (Structured checklist items)
model ScopeItem {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  // Item Details
  itemType    String // remove_carpet, sanitize_materials, install_dehumidification, etc.
  description String // Human-readable description
  areaId      String? // Link to AffectedArea if applicable
  
  // Quantities & Specifications
  quantity      Float? // Quantity if applicable
  unit          String? // sq ft, days, units, etc.
  specification String? @db.Text // Additional specs (e.g., drywall height)
  
  // System Determination
  autoDetermined Boolean @default(false) // True if system auto-added this
  justification  String? @db.Text // Why this item is required (IICRC/building code reference)
  
  // Status
  isRequired Boolean @default(true)
  isSelected Boolean @default(true) // User can deselect if not needed
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([inspectionId])
  @@index([itemType])
  @@index([autoDetermined])
}

// Cost Estimates (Line items with costs)
model CostEstimate {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  // Cost Item Details
  scopeItemId String? // Link to ScopeItem if applicable
  category    String // Equipment, Labor, Materials, etc.
  description String
  quantity    Float
  unit        String
  rate        Float // Cost per unit
  subtotal    Float // quantity × rate
  
  // Source
  costDatabaseId String? // Link to CostDatabase entry if used
  isEstimated    Boolean @default(true) // True if from database, false if custom
  
  // Totals
  contingency Float? // Contingency percentage applied
  total       Float // Final total including contingency
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([inspectionId])
  @@index([category])
}

// Classification (IICRC Category & Class determination)
model Classification {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  // Classification Result
  category String // 1, 2, 3, or 4 (IICRC S500)
  class    String // 1, 2, 3, or 4 (IICRC S500)
  
  // Justification
  justification     String @db.Text // Why this classification was determined
  standardReference String // IICRC S500 Section reference
  confidence        Float? // 0-100 confidence score
  
  // Input Data Used
  inputData String? @db.Text // JSON: data used for classification
  
  // Status
  isFinal    Boolean @default(false)
  reviewedBy String? // User ID if manually reviewed (shouldn't happen per spec)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([inspectionId])
  @@index([category])
  @@index([class])
}

// Audit Log (Complete audit trail)
model AuditLog {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  // Action Details
  action     String // Data entered, photo added, form submitted, classification determined, etc.
  entityType String? // EnvironmentalData, MoistureReading, AffectedArea, etc.
  entityId   String? // ID of the entity that was modified
  
  // User & Device
  userId      String
  device      String? // Mobile, Web
  gpsLocation String? // GPS coordinates if available
  
  // Changes
  changes       String? @db.Text // JSON: what was changed
  previousValue String? @db.Text // Previous value if applicable
  newValue      String? @db.Text // New value if applicable
  
  // Metadata
  timestamp DateTime @default(now())
  ipAddress String?
  userAgent String?
  
  @@index([inspectionId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

// Building Code Database (State-specific requirements)
model BuildingCode {
  id String @id @default(cuid())

  // Regulatory Document Link (NEW)
  regulatoryDocumentId String? // FK to RegulatoryDocument
  regulatoryDocument   RegulatoryDocument? @relation(fields: [regulatoryDocumentId], references: [id])
  
  // Location
  state    String // QLD, NSW, VIC, etc.
  postcode String? // Specific postcode if applicable (null = state-wide)
  
  // Requirements
  codeVersion              String // Building code version
  moistureThreshold        Float? // Moisture threshold % that triggers requirements
  dryingTimeStandard       String? @db.Text // Drying time standards
  dehumidificationRequired Boolean @default(false)
  certificationRequired    Boolean @default(false)
  
  // Specific Requirements (stored as JSON)
  requirements String? @db.Text // JSON: detailed requirements
  
  // Additional Context
  notes         String?   @db.Text
  effectiveDate DateTime?
  expiryDate    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([state])
  @@index([postcode])
  @@index([regulatoryDocumentId])
}

// ========================================
// REGULATORY DATA INTEGRATION MODELS (NEW)
// ========================================

enum RegulatoryDocumentType {
  INSURANCE_POLICY
  INSURANCE_REGULATION
  BUILDING_CODE_NATIONAL
  BUILDING_CODE_STATE
  ELECTRICAL_STANDARD
  PLUMBING_STANDARD
  CONSUMER_LAW
  INDUSTRY_BEST_PRACTICE
  SAFETY_REGULATION
}

// Primary regulatory document registry
model RegulatoryDocument {
  id String @id @default(cuid())

  documentType RegulatoryDocumentType
  category     String // Insurance, Building, Electrical, Consumer
  jurisdiction String? // AU (federal), QLD, NSW, VIC, etc.

  title         String
  documentCode  String? // "AS/NZS 3000:2023", "NCC 2025", "QDC 4.5"
  version       String
  effectiveDate DateTime
  expiryDate    DateTime?

  googleDriveFileId String?
  extractedText     String? @db.Text
  publisher         String
  sourceUrl         String?

  sections      RegulatorySection[]
  citations     Citation[]
  buildingCodes BuildingCode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentType, jurisdiction])
  @@index([documentCode])
}

// Granular section storage for fast retrieval
model RegulatorySection {
  id         String             @id @default(cuid())
  documentId String
  document   RegulatoryDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  sectionNumber String // "14.3.2", "Section 4.5.1"
  sectionTitle  String
  content       String  @db.Text
  summary       String? @db.Text

  topics   String[]
  keywords String[]

  applicableToWaterCategory String[]
  applicableToWaterClass    String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentId, sectionNumber])
  @@index([topics])
}

// Enhanced citation system
model Citation {
  id         String             @id @default(cuid())
  documentId String
  document   RegulatoryDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  fullReference   String // "IICRC S500 Section 14.3.2 (2025)"
  shortReference  String // "S500 Sec 14.3.2"
  citationText    String   @db.Text
  contextKeywords String[]

  usageCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shortReference])
}

// Insurance-specific requirements
model InsurancePolicyRequirement {
  id String @id @default(cuid())

  insurerName     String? // null = all insurers
  requirementType String
  description     String  @db.Text
  mandatory       Boolean @default(true)

  applicableStates  String[]
  standardReference String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([insurerName])
}

// Cost Database (National average costs for common items)
model CostDatabase {
  id String @id @default(cuid())
  
  // Item Details
  itemType    String // remove_carpet, drywall_removal, dehumidifier_rental, etc.
  category    String // Equipment, Labor, Materials, etc.
  description String
  unit        String // sq ft, day, unit, etc.
  
  // Cost Range
  minRate     Float // Minimum rate
  maxRate     Float // Maximum rate
  averageRate Float // Average rate (used for estimates)
  
  // Regional Variations
  region String? // National, QLD, NSW, etc. (null = national average)
  
  // Update Tracking
  lastUpdated     DateTime @default(now())
  source          String? // Source of the cost data
  updateFrequency String? // Quarterly, Monthly, etc.
  
  // Status
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([itemType])
  @@index([category])
  @@index([region])
  @@index([isActive])
}

// Inspection Photos
model InspectionPhoto {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  // Photo Details
  url          String // Cloudinary or S3 URL
  thumbnailUrl String? // Thumbnail URL if available
  location     String? // Location where photo was taken
  description  String? @db.Text // Photo description
  
  // Metadata
  timestamp  DateTime @default(now()) // When photo was taken
  uploadedAt DateTime @default(now()) // When photo was uploaded
  fileSize   Int? // File size in bytes
  mimeType   String? // image/jpeg, image/png, etc.
  
  // GPS if available
  gpsLatitude  Float?
  gpsLongitude Float?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([inspectionId])
  @@index([timestamp])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  role      String // "user" or "assistant"
  content   String   @db.Text
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
}

// ============================================
// AI ASSISTANT USAGE METERING (PHASE 1)
// ============================================

enum UsageEventType {
  PROPERTY_LOOKUP
  VOICE_TRANSCRIPTION
  VOICE_AI_INTERACTION
  LIDAR_SCAN
  FLOOR_PLAN_GENERATION
  AI_ASSISTANT_QUERY
}

model UsageEvent {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation("usageEvents", fields: [userId], references: [id], onDelete: Cascade)
  inspectionId String?
  inspection   Inspection? @relation("usageEvents", fields: [inspectionId], references: [id], onDelete: SetNull)
  scanId       String?
  scan         LidarScan?  @relation(fields: [scanId], references: [id], onDelete: SetNull)
  voiceNoteId  String? // NEW - links to VoiceNote (Phase 4)
  voiceNote    VoiceNote?  @relation(fields: [voiceNoteId], references: [id], onDelete: SetNull)

  eventType UsageEventType
  eventData String         @db.Text // JSON: specific details

  // Cost tracking
  unitCost  Float // Cost per unit (e.g., $0.0045/min)
  units     Float // Quantity (e.g., 5.2 minutes)
  totalCost Float // unitCost × units
  currency  String @default("AUD")

  // Stripe metering
  stripeMeterEventId String? // Stripe meter event ID
  billingStatus      String    @default("pending") // pending, billed, failed
  billedAt           DateTime?

  // Metadata
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, timestamp])
  @@index([inspectionId])
  @@index([scanId])
  @@index([voiceNoteId])
  @@index([billingStatus])
  @@index([eventType])
}

// Email Delivery System Models

// OAuth connection for Gmail/Microsoft email
model EmailConnection {
  id           String   @id @default(cuid())
  userId       String   @unique
  provider     String // "google" or "microsoft"
  email        String
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([provider])
}

// Scheduled email delivery
model ScheduledEmail {
  id          String    @id @default(cuid())
  userId      String
  reportId    String
  recipient   String // Email address
  scheduledAt DateTime // When to send
  sentAt      DateTime? // When actually sent
  status      String    @default("pending") // pending, sending, sent, failed, cancelled
  attempts    Int       @default(0)
  lastAttempt DateTime?
  error       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reportId])
  @@index([status, scheduledAt])
  @@index([scheduledAt])
}

// Audit trail for all email sends
model EmailAudit {
  id           String   @id @default(cuid())
  userId       String
  reportId     String
  recipient    String
  sentAt       DateTime @default(now())
  success      Boolean
  error        String?  @db.Text
  deliveryType String // "immediate" or "scheduled"

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reportId])
  @@index([sentAt])
}

// ============================================
// Forms Management System Models
// ============================================

// Form Template - defines structure of forms (pre-defined and custom)
model FormTemplate {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Template Metadata
  formType    FormType
  name        String
  description String?      @db.Text
  category    FormCategory

  // Template Status
  status           FormTemplateStatus @default(DRAFT)
  version          Int                @default(1)
  isSystemTemplate Boolean            @default(false) // True for pre-defined templates
  isActive         Boolean            @default(true)

  // Form Structure (JSON Schema for flexibility)
  formSchema String @db.Text // Complete form definition

  // Signature Requirements
  requiresSignatures Boolean @default(false)
  signatureConfig    String? @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  submissions       FormSubmission[]
  versions          FormTemplateVersion[]
  interviewSessions InterviewSession[]

  @@index([userId])
  @@index([formType])
  @@index([category])
  @@index([status])
  @@index([isSystemTemplate])
}

// Form Submission - instance of completed/in-progress form
model FormSubmission {
  id         String       @id @default(cuid())
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Linking to Reports/Jobs
  reportId String?
  report   Report? @relation(fields: [reportId], references: [id], onDelete: SetNull)

  // Submission Metadata
  submissionNumber String               @unique // Auto-generated (e.g., "WO-2026-001")
  status           FormSubmissionStatus @default(DRAFT)

  // Form Data (stores actual user inputs)
  formData String @db.Text // JSON: Field values

  // Completion Tracking
  completenessScore Int?    @default(0) // 0-100 percentage
  validationErrors  String? @db.Text

  // Timestamps
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  lastSavedAt DateTime  @default(now())
  completedAt DateTime?

  // Relations
  signatures  FormSignature[]
  attachments FormAttachment[]
  auditLogs   FormAuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([userId])
  @@index([reportId])
  @@index([status])
  @@index([submittedAt])
}

// Form Signature - digital signatures on forms
model FormSignature {
  id           String         @id @default(cuid())
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Signature Details
  signatureFieldId String
  signatureType    SignatureType

  // Digital Signature Data (Canvas-based)
  signatureData String? @db.Text // Base64-encoded PNG
  signatureUrl  String? // Cloudinary URL if uploaded

  // Signatory Information
  signatoryName  String
  signatoryRole  SignatoryRole
  signatoryEmail String?

  // E-signature Workflow
  signatureRequestSent   Boolean   @default(false)
  signatureRequestSentAt DateTime?

  // Verification
  ipAddress   String?
  userAgent   String?
  gpsLocation String?

  // Timestamps
  signedAt  DateTime?
  createdAt DateTime  @default(now())

  @@index([submissionId])
  @@index([signatoryRole])
}

// Form Attachment - files attached to submissions
model FormAttachment {
  id           String         @id @default(cuid())
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // File Details
  fileName     String
  fileUrl      String // Cloudinary URL
  thumbnailUrl String?
  publicId     String // Cloudinary public ID

  // Metadata
  fileSize Int // Bytes
  mimeType String
  fieldId  String? // If attached to specific field

  // Timestamps
  uploadedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([submissionId])
}

// Form Audit Log - track all changes
model FormAuditLog {
  id           String         @id @default(cuid())
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Action Details
  action  FormAuditAction
  fieldId String?

  // Change Data
  previousValue String? @db.Text
  newValue      String? @db.Text

  // User Context
  userId    String
  ipAddress String?
  userAgent String?

  // Timestamp
  timestamp DateTime @default(now())

  @@index([submissionId])
  @@index([userId])
  @@index([timestamp])
}

// Form Template Version - track template changes
model FormTemplateVersion {
  id         String       @id @default(cuid())
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Version Details
  version     Int
  changeNotes String? @db.Text
  changedBy   String

  // Snapshot
  schemaSnapshot String @db.Text

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([templateId, version])
  @@index([templateId])
}

// ============================================
// Authority Forms System
// ============================================

// Authority Form Template - defines form structure
model AuthorityFormTemplate {
  id          String   @id @default(cuid())
  name        String   // e.g., "Authority to Commence Work"
  code        String   @unique // e.g., "AUTH_COMMENCE", "AUTH_DISPOSE", "AUTH_NO_REMOVE"
  description String?  @db.Text
  formContent String   @db.Text // JSON: Form structure/fields
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  instances   AuthorityFormInstance[]
  
  @@index([code])
  @@index([isActive])
}

// Authority Form Instance - actual form for a report
model AuthorityFormInstance {
  id          String   @id @default(cuid())
  templateId  String
  template    AuthorityFormTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  reportId    String
  report      Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  // Auto-populated data (from report/client)
  companyName    String
  companyLogo    String? // URL
  companyABN     String?
  companyPhone   String?
  companyEmail   String?
  companyWebsite String?
  companyAddress String?
  
  clientName     String
  clientAddress  String
  incidentBrief  String? @db.Text // From report.technicianFieldReport or summary
  incidentDate   DateTime?
  
  // Form-specific authority description
  authorityDescription String @db.Text // The specific authority being granted
  
  // Status
  status        AuthorityFormStatus @default(DRAFT)
  
  // Signatures
  signatures    AuthorityFormSignature[]
  
  // Generated PDF
  pdfUrl        String? // Cloudinary URL for final signed PDF
  draftPdfUrl   String? // Cloudinary URL for draft PDF (before signatures)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?
  
  @@index([reportId])
  @@index([templateId])
  @@index([status])
}

// Authority Form Signature - signatures on authority forms
model AuthorityFormSignature {
  id          String   @id @default(cuid())
  instanceId  String
  instance    AuthorityFormInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  
  // Signatory Information
  signatoryName  String
  signatoryRole  AuthoritySignatoryRole
  signatoryEmail String?
  signatoryPhone String?
  
  // Signature Data
  signatureData String? @db.Text // Base64-encoded signature image
  signatureUrl  String? // Cloudinary URL if uploaded
  
  // E-signature Workflow
  signatureRequestSent   Boolean   @default(false)
  signatureRequestSentAt DateTime?
  signatureRequestToken  String?   @unique // Token for email signature link
  
  // Verification
  ipAddress   String?
  userAgent   String?
  signedAt    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([instanceId])
  @@index([signatoryRole])
  @@index([signatureRequestToken])
}

enum AuthorityFormStatus {
  DRAFT              // Form created, not yet sent for signatures
  PENDING_SIGNATURES // Sent to parties, awaiting signatures
  PARTIALLY_SIGNED   // Some signatures received
  COMPLETED          // All required signatures received
  CANCELLED
}

enum AuthoritySignatoryRole {
  CLIENT          // Property owner/client
  INSURER         // Insurance company representative
  CONTRACTOR      // Restoration contractor
  ADMIN           // Company admin/manager
  TECHNICIAN      // Field technician
  MANAGER         // Project manager
  PROPERTY_OWNER  // Property owner (alias for CLIENT)
}

// ============================================
// Forms Management System Enums
// ============================================

enum FormType {
  WORK_ORDER
  AUTHORITY_TO_COMMENCE
  JSA // Job Safety Analysis
  SDS // Safety Data Sheet
  SWIMS // Safe Work Information Management System
  SITE_INDUCTION
  CUSTOM
}

enum FormCategory {
  SAFETY
  COMPLIANCE
  CLIENT_INTAKE
  JOB_DOCUMENTATION
  INSURANCE
  QUALITY_CONTROL
  CUSTOM
}

enum FormTemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  DEPRECATED
}

enum FormSubmissionStatus {
  DRAFT
  IN_PROGRESS
  AWAITING_SIGNATURE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum SignatureType {
  DIGITAL_CANVAS // Hand-drawn on device
  ELECTRONIC_TYPED // Typed name with consent
  ESIGNATURE_WORKFLOW // Email-based e-signature
  BIOMETRIC // Future: fingerprint/face
}

enum SignatoryRole {
  TECHNICIAN
  SUPERVISOR
  CLIENT
  PROPERTY_OWNER
  WITNESS
  CONTRACTOR
  OTHER
}

enum FormAuditAction {
  CREATED
  FIELD_UPDATED
  SAVED
  SUBMITTED
  SIGNATURE_ADDED
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  STATUS_CHANGED
  CANCELLED
  REOPENED
}

// Interview System Enums & Models
// ================================

enum InterviewStatus {
  STARTED
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum QuestionType {
  YES_NO
  MULTIPLE_CHOICE
  TEXT
  NUMERIC
  MEASUREMENT
  LOCATION
  MULTISELECT
  CHECKBOX
}

enum SubscriptionTierLevel {
  STANDARD
  PREMIUM
  ENTERPRISE
}

model SubscriptionTier {
  id                       String                @id @default(cuid())
  tierName                 SubscriptionTierLevel
  monthlyPrice             Float
  features                 String?               @db.Text // JSON: feature flags
  standardsCoverage        String[] // Array: ["iicrc", "building", "electrical", "whs"]
  maxFormsPerMonth         Int?
  maxQuestionsPerInterview Int?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt

  users User[]

  @@unique([tierName])
  @@index([tierName])
}

model InterviewQuestion {
  id String @id @default(cuid())

  // Basic
  text           String       @db.Text
  type           QuestionType
  helperText     String?      @db.Text
  exampleAnswer  String?
  sequenceNumber Int?

  // Standards Backing
  standardsReference     String[] // JSON array: ["IICRC S500 s2"]
  standardsJustification String   @db.Text

  // Form Integration
  targetFormFields String[] // JSON array of formFieldIds
  fieldMappings    String   @db.Text // JSON: field mapping logic

  // Logic & Dependencies
  condition        String? @db.Text // Skip condition
  skipLogic        String? @db.Text // JSON: answer → nextQuestion
  conditionalShows String? @db.Text // JSON: conditional show rules

  // UI
  fieldGuidance String? @db.Text

  // Admin & Tier
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  isActive     Boolean               @default(true)
  minTierLevel SubscriptionTierLevel @default(STANDARD)

  // Usage Analytics
  usageCount         Int  @default(0)
  averageTimeSeconds Int?

  @@index([sequenceNumber])
  @@index([minTierLevel])
  @@index([isActive])
}

model InterviewSession {
  id               String  @id @default(cuid())
  userId           String
  formTemplateId   String
  formSubmissionId String?

  status      InterviewStatus @default(STARTED)
  startedAt   DateTime        @default(now())
  completedAt DateTime?
  abandonedAt DateTime?

  // Tracking
  totalQuestionsAsked  Int  @default(0)
  totalAnswersGiven    Int  @default(0)
  estimatedTimeMinutes Int  @default(5)
  actualTimeMinutes    Int?

  // Interview Data
  answers             String? @db.Text // JSON: all answers
  autoPopulatedFields String? @db.Text // JSON: field→value→confidence
  standardsReferences String? @db.Text // JSON: questions→standards

  // Equipment Recommendations
  equipmentRecommendations String? @db.Text // JSON: array
  estimatedEquipmentCost   Float?

  // User preferences
  userTierLevel        SubscriptionTierLevel
  technicianExperience String? // novice, experienced, expert

  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  formTemplate FormTemplate        @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  responses    InterviewResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([formTemplateId])
}

model InterviewResponse {
  id                 String @id @default(cuid())
  interviewSessionId String

  questionId   String
  questionText String       @db.Text
  answerValue  String?      @db.Text // JSON serialized
  answerType   QuestionType

  answeredAt       DateTime @default(now())
  timeSpentSeconds Int?

  // Field Auto-Population from this Answer
  populatedFields    String?  @db.Text // JSON: [{fieldId, value, confidence}]
  standardsReference String[] // Array of standard references

  // Relations
  interviewSession InterviewSession @relation(fields: [interviewSessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([interviewSessionId])
  @@index([questionId])
}

model InterviewStandardsMapping {
  id                 String @id @default(cuid())
  interviewSessionId String

  standardCode   String // "IICRC S500", "NCC 2025", etc.
  standardTitle  String
  questionsUsing String[] // Array of question IDs
  fieldsAffected String[] // Array of form field IDs
  confidence     Float // 0-100

  retrievedAt DateTime @default(now())
  usageCount  Int      @default(1)

  createdAt DateTime @default(now())

  @@index([interviewSessionId])
  @@index([standardCode])
}

// AI Assistant Tier - Phase 3: LiDAR Integration
model LidarScan {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  // File storage
  rawDataUrl String // Cloudinary URL to PLY/OBJ file
  fileFormat String // "ply", "obj", "e57"
  fileSize   Int // Bytes
  pointCount Int? // Number of points in cloud

  // Scan metadata
  roomName     String? // "Living Room", "Kitchen", etc.
  scanDuration Int? // Seconds spent scanning
  dimensions   String? @db.Text // JSON: {width, length, height, volume}

  // Processing
  processingStatus String    @default("pending") // pending, processing, completed, failed
  processedAt      DateTime?
  errorMessage     String?   @db.Text

  // Audit
  uploadedBy String
  uploadedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  floorPlan   FloorPlan?
  usageEvents UsageEvent[]

  @@index([inspectionId])
  @@index([processingStatus])
  @@index([uploadedBy])
}

model FloorPlan {
  id     String    @id @default(cuid())
  scanId String    @unique
  scan   LidarScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // Generated floor plan files
  imageUrl     String // 2D PNG/JPG floor plan
  svgUrl       String? // SVG vector version
  thumbnailUrl String? // Thumbnail

  // Floor plan data
  svgData    String? @db.Text // Raw SVG markup
  canvasJSON String? @db.Text // Fabric.js JSON for annotations

  // Dimensions
  scale      Float? // Pixels per meter
  dimensions String? @db.Text // JSON: {width, length, area, perimeter}

  // Annotations
  annotations String? @db.Text // JSON array of user annotations

  // Metadata
  generatedBy String // User or "system"
  generatedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([scanId])
}

// AI Assistant Tier - Phase 4: Voice AI Integration
model VoiceNote {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  // Audio file
  audioUrl    String // Cloudinary URL
  audioFormat String // "m4a", "wav"
  fileSize    Int // Bytes
  duration    Float // Seconds

  // Metadata
  roomName    String?
  description String? @db.Text

  // Transcription status
  transcriptionStatus String    @default("pending") // pending, processing, completed, failed
  transcribedAt       DateTime?
  transcriptionError  String?   @db.Text

  // Audit
  recordedBy String
  recordedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  transcript  VoiceTranscript?
  usageEvents UsageEvent[]

  @@index([inspectionId])
  @@index([transcriptionStatus])
  @@index([recordedBy])
}

model VoiceTranscript {
  id          String    @id @default(cuid())
  voiceNoteId String    @unique
  voiceNote   VoiceNote @relation(fields: [voiceNoteId], references: [id], onDelete: Cascade)

  // Transcript data
  text       String @db.Text
  language   String @default("en")
  confidence Float? // 0-1

  // Advanced features
  words    Json? // {word, start, end, confidence}[]
  speakers Json? // Speaker diarization data

  // AI extraction
  extractedData Json? // Structured data from Claude
  aiProcessed   Boolean   @default(false)
  aiProcessedAt DateTime?

  // Metadata
  transcriptionService String // "deepgram", "whisper"
  generatedAt          DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([voiceNoteId])
}

// AI Assistant Tier - Phase 5: Property Data Integration (CoreLogic)
model PropertyLookup {
  id String @id @default(cuid())

  // Lookup key (normalized: uppercase, trimmed)
  propertyAddress  String
  propertyPostcode String

  // Cache metadata
  lookupDate        DateTime @default(now())
  expiresAt         DateTime // lookupDate + 90 days
  apiResponseStatus Int // HTTP status code (200, 404, etc.)

  // Data source tracking (domain | realestate | onthehouse | corelogic)
  // Determines if lookup was free or charged
  dataSource String @default("corelogic") // "domain" | "realestate" | "onthehouse" | "corelogic"
  lookupCost Float  @default(0) // 0 for scrapers, 2.30 for CoreLogic
  confidence String @default("medium") // "high" | "medium" | "low"

  // Scraper response data (JSON) - includes both scraped and API data
  propertyData Json?

  // Relations
  inspectionId String?     @unique // One property lookup per inspection (one-to-one)
  inspection   Inspection? @relation(fields: [inspectionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for performance
  @@unique([propertyAddress, propertyPostcode], name: "address_postcode_unique")
  @@index([expiresAt])
  @@index([inspectionId])
}
